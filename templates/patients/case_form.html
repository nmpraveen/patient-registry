{% extends 'base.html' %}
{% block title %}Case Form | MEDTRACK{% endblock %}
{% block content %}
<style>
  .case-section-card {
    border: 1px solid #d9dee8;
    border-radius: 0.75rem;
    background: #fff;
  }
  .case-section-card .card-header {
    border-bottom: 1px solid #e8ecf4;
    background: #f3f7ff;
    border-radius: 0.75rem 0.75rem 0 0;
  }
  .ncd-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 0.5rem 1rem;
  }
  .ncd-grid .form-check {
    margin: 0;
    display: flex;
    align-items: center;
    gap: 0.45rem;
  }
  .ncd-grid .form-check-input {
    margin-top: 0;
    float: none;
  }
  .ncd-grid .form-check-label {
    margin-left: 0;
  }
  .autocomplete-panel {
    position: absolute;
    top: calc(100% + 0.25rem);
    left: 0;
    right: 0;
    z-index: 1050;
    max-height: 13rem;
    overflow-y: auto;
  }
  .autocomplete-panel .list-group-item {
    cursor: pointer;
  }
</style>

<div class="card shadow-sm"><div class="card-body">
  <h1 class="h4 mb-1">{% if object %}Edit Case{% else %}New Case{% endif %}</h1>
  <p class="text-muted small mb-3">Step 1: choose category Â· Step 2: complete relevant sections only.</p>

  <form method="post" class="row g-3" id="case-form">{% csrf_token %}
    <div class="col-12">
      <div class="case-section-card">
        <div class="card-header px-3 py-2">
          <h2 class="h6 mb-0">Case Type</h2>
        </div>
        <div class="card-body row g-3">
          <div class="col-12 col-md-6 field-wrap" data-field="category">
            <label class="form-label">{{ form.category.label }}</label>
            {{ form.category }}
          </div>
          <div class="col-12 col-md-6 field-wrap" data-field="status">
            <label class="form-label">{{ form.status.label }}</label>
            {{ form.status }}
          </div>
        </div>
      </div>
    </div>

    <div class="col-12">
      <div class="case-section-card">
        <div class="card-header px-3 py-2">
          <h2 class="h6 mb-0">Personal Details</h2>
        </div>
        <div class="card-body row g-3">
          <div class="col-md-6 field-wrap" data-field="uhid"><label class="form-label">{{ form.uhid.label }}</label>{{ form.uhid }}</div>
          <div class="col-md-6 field-wrap" data-field="first_name"><label class="form-label">{{ form.first_name.label }}</label>{{ form.first_name }}</div>
          <div class="col-md-6 field-wrap" data-field="last_name"><label class="form-label">{{ form.last_name.label }}</label>{{ form.last_name }}</div>
          <div class="col-md-6 field-wrap" data-field="gender"><label class="form-label">{{ form.gender.label }}</label>{{ form.gender }}</div>
          <div class="col-md-6 field-wrap" data-field="date_of_birth">
            <label class="form-label">{{ form.date_of_birth.label }}</label>
            {{ form.date_of_birth }}
            <div class="form-text">When DOB is entered, age is auto-calculated.</div>
          </div>
          <div class="col-md-6 field-wrap" data-field="age">
            <label class="form-label">{{ form.age.label }}</label>
            {{ form.age }}
            <div class="form-text" id="age-help-text">Enter age manually only if DOB is unknown.</div>
          </div>
          <div class="col-md-6 field-wrap" data-field="place"><label class="form-label">{{ form.place.label }}</label>{{ form.place }}</div>
          <div class="col-md-6 field-wrap" data-field="phone_number"><label class="form-label">{{ form.phone_number.label }}</label>{{ form.phone_number }}</div>
          <div class="col-md-6 field-wrap" data-field="alternate_phone_number"><label class="form-label">{{ form.alternate_phone_number.label }}</label>{{ form.alternate_phone_number }}</div>
        </div>
      </div>
    </div>

    <div class="col-12">
      <div class="case-section-card">
        <div class="card-header px-3 py-2">
          <h2 class="h6 mb-0">Diagnosis & Follow-up Details</h2>
        </div>
        <div class="card-body row g-3">
          <div class="col-md-6 field-wrap" data-field="diagnosis"><label class="form-label">{{ form.diagnosis.label }}</label>{{ form.diagnosis }}</div>
          <div class="col-md-6 field-wrap" data-field="lmp"><label class="form-label">{{ form.lmp.label }}</label>{{ form.lmp }}</div>
          <div class="col-md-6 field-wrap" data-field="edd"><label class="form-label">{{ form.edd.label }}</label>{{ form.edd }}</div>
          <div class="col-md-6 field-wrap" data-field="usg_edd"><label class="form-label">{{ form.usg_edd.label }}</label>{{ form.usg_edd }}</div>
          <div class="col-md-6 field-wrap" data-field="surgical_pathway"><label class="form-label">{{ form.surgical_pathway.label }}</label>{{ form.surgical_pathway }}</div>
          <div class="col-md-6 field-wrap" data-field="surgery_done"><label class="form-label">{{ form.surgery_done.label }}</label>{{ form.surgery_done }}</div>
          <div class="col-md-6 field-wrap" data-field="surgery_date"><label class="form-label">{{ form.surgery_date.label }}</label>{{ form.surgery_date }}</div>
          <div class="col-md-6 field-wrap" data-field="review_frequency"><label class="form-label">{{ form.review_frequency.label }}</label>{{ form.review_frequency }}</div>
          <div class="col-md-6 field-wrap" data-field="review_date"><label class="form-label">{{ form.review_date.label }}</label>{{ form.review_date }}</div>
          <div class="col-md-3 field-wrap" data-field="gravida"><label class="form-label">G</label>{{ form.gravida }}</div>
          <div class="col-md-3 field-wrap" data-field="para"><label class="form-label">P</label>{{ form.para }}</div>
          <div class="col-md-3 field-wrap" data-field="abortions"><label class="form-label">A</label>{{ form.abortions }}</div>
          <div class="col-md-3 field-wrap" data-field="living"><label class="form-label">L</label>{{ form.living }}<div id="gpla-warning" class="small text-warning d-none">L is greater than P (allowed for multiple births).</div></div>
        </div>
      </div>
    </div>

    <div class="col-12">
      <div class="case-section-card">
        <div class="card-header px-3 py-2">
          <h2 class="h6 mb-0">Risk Factors</h2>
        </div>
        <div class="card-body row g-3">
          <div class="col-md-6 field-wrap" data-field="high_risk"><label class="form-label">{{ form.high_risk.label }}</label>{{ form.high_risk }}</div>
          <div class="col-12 field-wrap" data-field="anc_high_risk_reasons">
            <label class="form-label">{{ form.anc_high_risk_reasons.label }}</label>
            <div class="ncd-grid border rounded p-2 bg-light-subtle">
              {% for choice in form.anc_high_risk_reasons %}
                <div class="form-check">
                  {{ choice.tag }}
                  <label class="form-check-label" for="{{ choice.id_for_label }}">{{ choice.choice_label }}</label>
                </div>
              {% endfor %}
            </div>
          </div>
          <div class="col-md-6 field-wrap" data-field="ncd_flags">
            <label class="form-label">{{ form.ncd_flags.label }}</label>
            <div class="ncd-grid border rounded p-2 bg-light-subtle">
              {% for choice in form.ncd_flags %}
                <div class="form-check">
                  {{ choice.tag }}
                  <label class="form-check-label" for="{{ choice.id_for_label }}">{{ choice.choice_label }}</label>
                </div>
              {% endfor %}
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-12">
      <div class="case-section-card">
        <div class="card-header px-3 py-2">
          <h2 class="h6 mb-0">Referral Notes</h2>
        </div>
        <div class="card-body row g-3">
          <div class="col-md-6 field-wrap" data-field="referred_by"><label class="form-label">{{ form.referred_by.label }}</label>{{ form.referred_by }}</div>
          <div class="col-md-6 field-wrap" data-field="notes"><label class="form-label">{{ form.notes.label }}</label>{{ form.notes }}</div>
        </div>
      </div>
    </div>

    {% for field in form %}
      {% for error in field.errors %}<div class="col-12 text-danger small">{{ field.label }}: {{ error }}</div>{% endfor %}
    {% endfor %}
    {% if form.non_field_errors %}<div class="col-12 text-danger small">{{ form.non_field_errors }}</div>{% endif %}
    <div class="col-12"><button class="btn btn-primary">Save Case</button></div>
  </form>
</div></div>

<script>
(function() {
  const categoryEl = document.getElementById('id_category');
  if (!categoryEl) return;

  const dobEl = document.getElementById('id_date_of_birth');
  const ageEl = document.getElementById('id_age');
  const ageHelpText = document.getElementById('age-help-text');
  const highRiskEl = document.getElementById('id_high_risk');

  const fieldsForCategory = {
    anc: ['lmp', 'edd', 'usg_edd', 'gravida', 'para', 'abortions', 'living', 'high_risk', 'anc_high_risk_reasons'],
    surgery: ['surgical_pathway', 'surgery_done', 'surgery_date', 'review_date'],
    nonsurgical: ['review_frequency', 'review_date']
  };
  const allConditional = ['lmp', 'edd', 'usg_edd', 'surgical_pathway', 'surgery_done', 'surgery_date', 'review_frequency', 'review_date', 'gravida', 'para', 'abortions', 'living', 'high_risk', 'anc_high_risk_reasons'];
  const normalize = (txt) => (txt || '').toLowerCase().replace(/[^a-z]/g, '');

  function calculateAgeFromDob(dobValue) {
    if (!dobValue) return '';
    const dob = new Date(dobValue);
    if (Number.isNaN(dob.getTime())) return '';

    const today = new Date();
    let years = today.getFullYear() - dob.getFullYear();
    const monthDiff = today.getMonth() - dob.getMonth();
    const dayDiff = today.getDate() - dob.getDate();
    if (monthDiff < 0 || (monthDiff === 0 && dayDiff < 0)) {
      years -= 1;
    }
    return years >= 0 ? years : '';
  }

  function updateAgeBehavior() {
    if (!dobEl || !ageEl) return;
    if (dobEl.value) {
      ageEl.value = calculateAgeFromDob(dobEl.value);
      ageEl.setAttribute('readonly', 'readonly');
      ageHelpText.textContent = 'Age is auto-calculated from DOB.';
    } else {
      ageEl.removeAttribute('readonly');
      ageHelpText.textContent = 'Enter age manually only if DOB is unknown.';
    }
  }

  function updateFieldVisibility() {
    const normalized = normalize(categoryEl.options[categoryEl.selectedIndex]?.text);
    const allowed = new Set(fieldsForCategory[normalized] || []);
    document.querySelectorAll('.field-wrap[data-field]').forEach((wrapper) => {
      const name = wrapper.dataset.field;
      if (!allConditional.includes(name)) return;
      wrapper.classList.toggle('d-none', !allowed.has(name));
    });
    updateAncHighRiskReasonsVisibility();
  }

  function updateAncHighRiskReasonsVisibility() {
    const normalized = normalize(categoryEl.options[categoryEl.selectedIndex]?.text);
    const reasonsWrap = document.querySelector('.field-wrap[data-field="anc_high_risk_reasons"]');
    if (!reasonsWrap) return;

    const showReasons = normalized === 'anc' && Boolean(highRiskEl?.checked);
    reasonsWrap.classList.toggle('d-none', !showReasons);

    reasonsWrap.querySelectorAll('input[type="checkbox"]').forEach((checkbox) => {
      checkbox.disabled = !showReasons;
    });
  }

  function updateGPLAWarning() {
    const para = parseInt(document.getElementById('id_para')?.value || '0', 10);
    const living = parseInt(document.getElementById('id_living')?.value || '0', 10);
    document.getElementById('gpla-warning')?.classList.toggle('d-none', !(living > para));
  }

  function initAutocomplete(inputId, fieldName) {
    const inputEl = document.getElementById(inputId);
    if (!inputEl) return;

    const container = inputEl.closest('.field-wrap') || inputEl.parentElement;
    if (!container) return;
    container.classList.add('position-relative');

    const panelId = `${inputId}-autocomplete`;
    const panelEl = document.createElement('div');
    panelEl.id = panelId;
    panelEl.className = 'autocomplete-panel list-group shadow-sm d-none';
    panelEl.setAttribute('role', 'listbox');
    panelEl.setAttribute('aria-label', `${fieldName} suggestions`);
    container.appendChild(panelEl);
    inputEl.setAttribute('autocomplete', 'off');
    inputEl.setAttribute('aria-controls', panelId);

    let suggestions = [];
    let activeIndex = -1;
    let currentRequestId = 0;

    function closePanel() {
      panelEl.classList.add('d-none');
      panelEl.innerHTML = '';
      suggestions = [];
      activeIndex = -1;
      inputEl.removeAttribute('aria-activedescendant');
    }

    function selectSuggestion(index) {
      if (index < 0 || index >= suggestions.length) return;
      inputEl.value = suggestions[index];
      closePanel();
    }

    function setActiveSuggestion(index) {
      activeIndex = index;
      Array.from(panelEl.children).forEach((itemEl, itemIndex) => {
        itemEl.classList.toggle('active', itemIndex === activeIndex);
      });
      if (activeIndex >= 0) {
        const activeEl = panelEl.children[activeIndex];
        if (activeEl) {
          inputEl.setAttribute('aria-activedescendant', activeEl.id);
          activeEl.scrollIntoView({ block: 'nearest' });
        }
      } else {
        inputEl.removeAttribute('aria-activedescendant');
      }
    }

    function renderSuggestions(items) {
      panelEl.innerHTML = '';
      suggestions = items;
      activeIndex = -1;

      if (!items.length) {
        closePanel();
        return;
      }

      items.forEach((item, index) => {
        const itemEl = document.createElement('button');
        itemEl.type = 'button';
        itemEl.className = 'list-group-item list-group-item-action py-1 px-2 small';
        itemEl.id = `${panelId}-item-${index}`;
        itemEl.setAttribute('role', 'option');
        itemEl.textContent = item;
        itemEl.addEventListener('mouseenter', () => setActiveSuggestion(index));
        itemEl.addEventListener('mousedown', (event) => {
          event.preventDefault();
          selectSuggestion(index);
        });
        panelEl.appendChild(itemEl);
      });

      panelEl.classList.remove('d-none');
    }

    async function fetchSuggestions(query) {
      const requestId = ++currentRequestId;
      const params = new URLSearchParams({ field: fieldName, q: query });
      try {
        const response = await fetch(`{% url 'patients:case_autocomplete' %}?${params.toString()}`, {
          headers: { 'X-Requested-With': 'XMLHttpRequest' },
          credentials: 'same-origin'
        });
        if (!response.ok || requestId !== currentRequestId) {
          return;
        }
        const data = await response.json();
        if (requestId !== currentRequestId) return;
        renderSuggestions(Array.isArray(data) ? data : []);
      } catch (error) {
        closePanel();
      }
    }

    let debounceHandle = null;

    inputEl.addEventListener('input', () => {
      const query = inputEl.value.trim();
      if (debounceHandle) {
        window.clearTimeout(debounceHandle);
      }
      if (query.length < 2) {
        closePanel();
        return;
      }
      debounceHandle = window.setTimeout(() => fetchSuggestions(query), 200);
    });

    inputEl.addEventListener('keydown', (event) => {
      if (panelEl.classList.contains('d-none')) {
        return;
      }
      if (event.key === 'ArrowDown') {
        event.preventDefault();
        setActiveSuggestion((activeIndex + 1) % suggestions.length);
      } else if (event.key === 'ArrowUp') {
        event.preventDefault();
        setActiveSuggestion((activeIndex - 1 + suggestions.length) % suggestions.length);
      } else if (event.key === 'Enter') {
        if (activeIndex >= 0) {
          event.preventDefault();
          selectSuggestion(activeIndex);
        }
      } else if (event.key === 'Escape') {
        closePanel();
      }
    });

    inputEl.addEventListener('blur', () => {
      window.setTimeout(closePanel, 120);
    });
  }

  categoryEl.addEventListener('change', updateFieldVisibility);
  highRiskEl?.addEventListener('change', updateAncHighRiskReasonsVisibility);
  dobEl?.addEventListener('change', updateAgeBehavior);
  document.getElementById('id_para')?.addEventListener('change', updateGPLAWarning);
  document.getElementById('id_living')?.addEventListener('change', updateGPLAWarning);

  initAutocomplete('id_place', 'place');
  initAutocomplete('id_diagnosis', 'diagnosis');
  initAutocomplete('id_referred_by', 'referred_by');

  updateFieldVisibility();
  updateGPLAWarning();
  updateAgeBehavior();
})();
</script>
{% endblock %}
