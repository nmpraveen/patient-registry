{% extends 'base.html' %}
{% block title %}Case {{ case.uhid }} | MEDTRACK{% endblock %}
{% block content %}
<div class="d-flex flex-column flex-md-row justify-content-between align-items-start gap-2 mb-3">
  <div>
    <h1 class="h4 mb-1">{{ case.full_name }} <small class="text-muted">({{ case.uhid }})</small></h1>
    <p class="mb-0 small">
      {% if case.gender %}Gender: {{ case.get_gender_display }} · {% endif %}
      {% if case.date_of_birth %}DOB: {{ case.date_of_birth }} · {% endif %}
      {% if case.place %}Place: {{ case.place }} · {% endif %}
      Phone: {{ case.phone_number }} · Category: {{ case.category.name }} · Status: {{ case.get_status_display }}
    </p>
    <p class="mb-0 small text-muted">
      {% if case.lmp %}LMP {{ case.lmp }}{% endif %} {% if case.edd %}· EDD {{ case.edd }}{% endif %}
      {% if case.usg_edd %}· USG-EDD {{ case.usg_edd }}{% endif %}
      {% if case.trimester %}· {{ case.trimester }} trimester{% endif %}
      {% if case.surgical_pathway %}· {{ case.get_surgical_pathway_display }}{% endif %}
      {% if case.review_date %}· Next review {{ case.review_date }}{% endif %}
    </p>
  </div>
  <a class="btn btn-outline-primary btn-sm" href="{% url 'patients:case_edit' case.id %}">Edit Case</a>
</div>
<div class="row g-3 g-md-4">
  <div class="col-12 col-lg-7">
    <div class="card mb-3"><div class="card-body">
      <h2 class="h5">Tasks</h2>
      <div class="table-responsive">
        <table class="table table-sm align-middle">
          <thead><tr><th>Title</th><th>Due</th><th>Status</th><th class="d-none d-md-table-cell">Freq</th><th class="d-none d-md-table-cell">Assigned</th><th></th></tr></thead>
          <tbody>
          {% for task in tasks %}
            <tr {% if case.category.name|upper == 'ANC' and task.due_date > today %}class="table-secondary"{% endif %}>
              <td>{{ task.title }}</td>
              <td>{{ task.due_date }}</td>
              <td>{{ task.get_status_display }}</td>
              <td class="d-none d-md-table-cell">{{ task.frequency_label|default:'-' }}</td>
              <td class="d-none d-md-table-cell">{{ task.assigned_user|default:'-' }}</td>
              <td>
                {% if can_task_edit %}
                  {% if case.category.name|upper == 'ANC' and task.due_date > today %}
                    <span class="text-muted small">Locked until due date</span>
                  {% else %}
                    <a href="{% url 'patients:task_edit' task.id %}">Edit</a>
                  {% endif %}
                {% else %}-{% endif %}
              </td>
            </tr>
          {% empty %}<tr><td colspan="6">No tasks added yet.</td></tr>{% endfor %}
          </tbody>
        </table>
      </div>
      {% if can_task_create %}
      <hr>
      <h3 class="h6">Add Task</h3>
      <form method="post" action="{% url 'patients:task_create' case.id %}" class="row g-2">{% csrf_token %}
        {% for field in task_form %}<div class="col-12 col-md-6"><label class="form-label small">{{ field.label }}</label>{{ field }}</div>{% endfor %}
        <div class="col-12"><button class="btn btn-primary btn-sm w-100 w-sm-auto">Add Task</button></div>
      </form>
      {% endif %}
    </div></div>
  </div>
  <div class="col-12 col-lg-5">
    <div class="card"><div class="card-body">
      <h2 class="h5">Activity Log</h2>
      {% if can_note_add %}
      <form method="post" action="{% url 'patients:case_note_create' case.id %}" class="mb-3">{% csrf_token %}
        <div class="mb-2">{{ log_form.task.label_tag }} {{ log_form.task }}</div>
        <div class="mb-2">{{ log_form.note.label_tag }} {{ log_form.note }}</div>
        <button class="btn btn-secondary btn-sm w-100">Add Note</button>
      </form>
      {% endif %}
      <ul class="list-group list-group-flush">
        {% for log in activity_logs %}
          <li class="list-group-item px-0"><small class="text-muted">{{ log.created_at }} · {{ log.user|default:'system' }}{% if log.task %} · {{ log.task.title }}{% endif %}</small><div>{{ log.note }}</div></li>
        {% empty %}<li class="list-group-item px-0">No activity yet.</li>{% endfor %}
      </ul>
    </div></div>
  </div>
</div>
{% endblock %}
