{% extends 'base.html' %}
{% block title %}Dashboard | MEDTRACK{% endblock %}
{% block content %}
<h1 class="h4 mb-3">Dashboard</h1>
<div class="row g-2 g-md-3 mb-4">
  <div class="col-6 col-md-2"><div class="card border-primary-subtle"><div class="card-body py-2 py-md-3 bg-primary-subtle"><small>Today's</small><div class="h5 mb-0">{{ today_tasks|length }}</div></div></div></div>
  <div class="col-6 col-md-2"><div class="card border-info-subtle"><div class="card-body py-2 py-md-3 bg-info-subtle"><small>Upcoming</small><div class="h5 mb-0">{{ upcoming_tasks|length }}</div></div></div></div>
  <div class="col-6 col-md-2"><div class="card border-danger-subtle"><div class="card-body py-2 py-md-3 bg-danger-subtle"><small>Overdue</small><div class="h5 mb-0 text-danger">{{ overdue_tasks|length }}</div></div></div></div>
  <div class="col-6 col-md-2"><div class="card border-success-subtle"><div class="card-body py-2 py-md-3 bg-success-subtle"><small>ANC</small><div class="h5 mb-0">{{ anc_case_count }}</div></div></div></div>
  <div class="col-6 col-md-2"><div class="card border-warning-subtle"><div class="card-body py-2 py-md-3 bg-warning-subtle"><small>Surgery</small><div class="h5 mb-0">{{ surgery_case_count }}</div></div></div></div>
  <div class="col-6 col-md-2"><div class="card border-secondary-subtle"><div class="card-body py-2 py-md-3 bg-secondary-subtle"><small>Non Surgical</small><div class="h5 mb-0">{{ non_surgical_case_count }}</div></div></div></div>
</div>

<div class="row g-3 g-md-4">
  <div class="col-12 col-lg-6">
    <h2 class="h6">Today's Tasks</h2>
    {% for card in today_cards %}
      <div class="card mb-3 shadow-sm">
        <div class="card-body py-2 px-3">
          <div class="d-flex align-items-center flex-wrap gap-1 small">
            <span class="text-muted">{{ card.due_date|date:'M d' }} â€”</span>
            <a class="fw-semibold text-decoration-none" href="{% url 'patients:case_detail' card.case_id %}">{{ card.patient_name }}</a>
            <span class="text-muted">/ {{ card.diagnosis }} /</span>
            {% if card.high_risk %}<span title="High-risk case" class="text-danger">â—</span>{% endif %}
            {% if card.referred_by %}<span title="Referred by: {{ card.referred_by }}">â­</span>{% endif %}
            {% if card.ncd_flags %}<span class="text-muted" title="NCD flags: {{ card.ncd_flags|join:', ' }}">ğŸ·ï¸</span>{% endif %}
            {% if card.call_status == "CONFIRMED" %}<span title="Confirmed">ğŸŸ¢ğŸ“</span>
            {% elif card.call_status == "NOT_REACHABLE" %}<span title="Not reachable">ğŸ”´ğŸ“ x{{ card.failed_attempt_count }}</span>
            {% elif card.call_status == "INVALID_CONTACT" %}<span title="Invalid contact">âš ï¸ğŸ“</span>
            {% elif card.call_status == "LOST" %}<span title="Lost follow-up">âŒ</span>
            {% elif card.call_status == "CALL_BACK_LATER" %}<span title="Call back later">ğŸŸ¡ğŸ“</span>
            {% else %}<span title="Not contacted">ğŸ“</span>{% endif %}
            <a class="text-decoration-none" href="tel:{{ card.phone_number }}" data-bs-toggle="collapse" data-bs-target="#today-phone-{{ forloop.counter }}" aria-expanded="false" aria-controls="today-phone-{{ forloop.counter }}" title="Show and call patient number">â˜ï¸</a>
            <span id="today-phone-{{ forloop.counter }}" class="collapse text-muted">{{ card.phone_number }}</span>
          </div>
          <div class="text-muted small mt-1">{{ card.task_titles|join:' â€¢ ' }}</div>
        </div>
      </div>
    {% empty %}
      <div class="card"><div class="card-body">No tasks due today.</div></div>
    {% endfor %}

    <h2 class="h6 mt-3">Upcoming ({{ upcoming_days }} days)</h2>
    {% for card in upcoming_cards %}
      <div class="card mb-3 shadow-sm">
        <div class="card-body py-2 px-3">
          <div class="d-flex align-items-center flex-wrap gap-1 small">
            <span class="text-muted">{{ card.due_date|date:'M d' }} â€”</span>
            <a class="fw-semibold text-decoration-none" href="{% url 'patients:case_detail' card.case_id %}">{{ card.patient_name }}</a>
            <span class="text-muted">/ {{ card.diagnosis }} /</span>
            {% if card.high_risk %}<span title="High-risk case" class="text-danger">â—</span>{% endif %}
            {% if card.referred_by %}<span title="Referred by: {{ card.referred_by }}">â­</span>{% endif %}
            {% if card.ncd_flags %}<span class="text-muted" title="NCD flags: {{ card.ncd_flags|join:', ' }}">ğŸ·ï¸</span>{% endif %}
            {% if card.call_status == "CONFIRMED" %}<span title="Confirmed">ğŸŸ¢ğŸ“</span>
            {% elif card.call_status == "NOT_REACHABLE" %}<span title="Not reachable">ğŸ”´ğŸ“ x{{ card.failed_attempt_count }}</span>
            {% elif card.call_status == "INVALID_CONTACT" %}<span title="Invalid contact">âš ï¸ğŸ“</span>
            {% elif card.call_status == "LOST" %}<span title="Lost follow-up">âŒ</span>
            {% elif card.call_status == "CALL_BACK_LATER" %}<span title="Call back later">ğŸŸ¡ğŸ“</span>
            {% else %}<span title="Not contacted">ğŸ“</span>{% endif %}
            <a class="text-decoration-none" href="tel:{{ card.phone_number }}" data-bs-toggle="collapse" data-bs-target="#upcoming-phone-{{ forloop.counter }}" aria-expanded="false" aria-controls="upcoming-phone-{{ forloop.counter }}" title="Show and call patient number">â˜ï¸</a>
            <span id="upcoming-phone-{{ forloop.counter }}" class="collapse text-muted">{{ card.phone_number }}</span>
          </div>
          <div class="text-muted small mt-1">{{ card.task_titles|join:' â€¢ ' }}</div>
        </div>
      </div>
    {% empty %}
      <div class="card"><div class="card-body">No upcoming tasks.</div></div>
    {% endfor %}
  </div>

  <div class="col-12 col-lg-6">
    <h2 class="h6">Overdue Tasks</h2>
    {% for card in overdue_cards %}
      <div class="card mb-3 border-danger-subtle shadow-sm">
        <div class="card-body py-2 px-3">
          <div class="d-flex align-items-center flex-wrap gap-1 small">
            <span class="text-danger">{{ card.due_date|date:'M d' }} â€”</span>
            <a class="fw-semibold text-decoration-none" href="{% url 'patients:case_detail' card.case_id %}">{{ card.patient_name }}</a>
            <span class="text-muted">/ {{ card.diagnosis }} /</span>
            {% if card.high_risk %}<span title="High-risk case" class="text-danger">â—</span>{% endif %}
            {% if card.referred_by %}<span title="Referred by: {{ card.referred_by }}">â­</span>{% endif %}
            {% if card.ncd_flags %}<span class="text-muted" title="NCD flags: {{ card.ncd_flags|join:', ' }}">ğŸ·ï¸</span>{% endif %}
            {% if card.call_status == "CONFIRMED" %}<span title="Confirmed">ğŸŸ¢ğŸ“</span>
            {% elif card.call_status == "NOT_REACHABLE" %}<span title="Not reachable">ğŸ”´ğŸ“ x{{ card.failed_attempt_count }}</span>
            {% elif card.call_status == "INVALID_CONTACT" %}<span title="Invalid contact">âš ï¸ğŸ“</span>
            {% elif card.call_status == "LOST" %}<span title="Lost follow-up">âŒ</span>
            {% elif card.call_status == "CALL_BACK_LATER" %}<span title="Call back later">ğŸŸ¡ğŸ“</span>
            {% else %}<span title="Not contacted">ğŸ“</span>{% endif %}
            <a class="text-decoration-none" href="tel:{{ card.phone_number }}" data-bs-toggle="collapse" data-bs-target="#overdue-phone-{{ forloop.counter }}" aria-expanded="false" aria-controls="overdue-phone-{{ forloop.counter }}" title="Show and call patient number">â˜ï¸</a>
            <span id="overdue-phone-{{ forloop.counter }}" class="collapse text-muted">{{ card.phone_number }}</span>
          </div>
          <div class="text-muted small mt-1">{{ card.task_titles|join:' â€¢ ' }}</div>
        </div>
      </div>
    {% empty %}
      <div class="card"><div class="card-body">No overdue tasks.</div></div>
    {% endfor %}

    <h2 class="h6">Awaiting Reports</h2>
    <ul class="list-group">
      {% for task in awaiting_tasks %}<li class="list-group-item small"><a href="{% url 'patients:case_detail' task.case_id %}">{{ task.case.full_name }}</a> â€” {{ task.title }}</li>{% empty %}<li class="list-group-item">No awaiting-report tasks.</li>{% endfor %}
    </ul>
    <p class="mt-3 mb-0 small"><strong>Cases:</strong> Active {{ active_case_count }} Â· Completed {{ completed_case_count }}</p>
  </div>
</div>
{% endblock %}
